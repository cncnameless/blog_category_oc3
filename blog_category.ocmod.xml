<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Blog Category System</name>
    <code>blog_category</code>
    <version>1.0</version>
    <author>cncnameless</author>
    <link>https://github.com/cncnameless/blog_category_oc3</link>

    <file path="admin/controller/marketplace/extension.php">
        <operation>
            <search><![CDATA[$extensions = $this->model_setting_extension->getInstalled($type);]]></search>
            <add position="after"><![CDATA[
            if ($type == 'module') {
                if (!in_array('blog_category', $extensions)) {
                    $this->model_setting_extension->install('module', 'blog_category');
                    $extensions = $this->model_setting_extension->getInstalled($type);
                }
            }
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/common/column_left.php">
        <operation>
            <search><![CDATA[// Catalog]]></search>
            <add position="before"><![CDATA[
            // Blog
            $blog = array();

            if ($this->user->hasPermission('access', 'extension/module/blog_category')) {
                $blog[] = array(
                    'name'     => 'Категории блога',
                    'href'     => $this->url->link('extension/module/blog_category', 'user_token=' . $this->session->data['user_token'], true),
                    'children' => array()
                );
            }

            if ($blog) {
                $data['menus'][] = array(
                    'id'       => 'menu-blog',
                    'icon'	   => 'fa fa-book',
                    'name'	   => 'Blog',
                    'href'     => '',
                    'children' => $blog
                );
            }
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/startup/seo_url.php">
        <operation>
            <search><![CDATA[if ($query->row['query'] && $url[0] == 'information_id') {]]></search>
            <add position="before"><![CDATA[
            if ($url[0] == 'blog_category_id') {
                $this->request->get['blog_category_id'] = $url[1];
            }
            
            if (isset($this->request->get['blog_category_id'])) {
                $this->request->get['route'] = 'extension/module/blog_category';
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[} elseif (isset($this->request->get['information_id'])) {]]></search>
            <add position="before"><![CDATA[
            } elseif (isset($this->request->get['blog_category_id'])) {
                $this->request->get['route'] = 'extension/module/blog_category';
            ]]></add>
        </operation>
    </file>

    <!-- Admin modifications for information (category selection) -->
    <file path="admin/controller/catalog/information.php">
        <operation>
            <search><![CDATA[protected function getForm() {]]></search>
            <add position="after"><![CDATA[
            $data['text_blog_category'] = $this->language->get('text_blog_category');
            $this->load->model('extension/module/blog_category');
            $data['blog_categories'] = $this->model_extension_module_blog_category->getBlogCategories(array());
            if (isset($this->request->post['information_to_blog_category'])) {
                $data['information_to_blog_category'] = $this->request->post['information_to_blog_category'];
            } elseif (!empty($information_info)) {
                $data['information_to_blog_category'] = $this->model_catalog_information->getInformationBlogCategories($information_id);
            } else {
                $data['information_to_blog_category'] = array();
            }
            ]]></add>
        </operation>
    </file>

    <file path="admin/model/catalog/information.php">
        <operation>
            <search><![CDATA[public function addInformation($data) {]]></search>
            <add position="after"><![CDATA[
            $information_id = $this->db->getLastId();
            if (isset($data['information_to_blog_category'])) {
                foreach ($data['information_to_blog_category'] as $blog_category_id) {
                    $this->db->query("INSERT INTO `blog_to_category` SET information_id = '" . (int)$information_id . "', blog_category_id = '" . (int)$blog_category_id . "'");
                }
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[public function editInformation($information_id, $data) {]]></search>
            <add position="after"><![CDATA[
            $this->db->query("DELETE FROM `blog_to_category` WHERE information_id = '" . (int)$information_id . "'");
            if (isset($data['information_to_blog_category'])) {
                foreach ($data['information_to_blog_category'] as $blog_category_id) {
                    $this->db->query("INSERT INTO `blog_to_category` SET information_id = '" . (int)$information_id . "', blog_category_id = '" . (int)$blog_category_id . "'");
                }
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[public function deleteInformation($information_id) {]]></search>
            <add position="after"><![CDATA[
            $this->db->query("DELETE FROM `blog_to_category` WHERE information_id = '" . (int)$information_id . "'");
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[public function getInformation($information_id) {]]></search>
            <add position="before"><![CDATA[
            public function getInformationBlogCategories($information_id) {
                $information_blog_category_data = array();
                $query = $this->db->query("SELECT * FROM `blog_to_category` WHERE information_id = '" . (int)$information_id . "'");
                foreach ($query->rows as $result) {
                    $information_blog_category_data[] = $result['blog_category_id'];
                }
                return $information_blog_category_data;
            }
            ]]></add>
        </operation>
    </file>

    <file path="admin/view/template/catalog/information_form.twig">
        <operation>
            <search><![CDATA[<label class="col-sm-2 control-label" for="input-sort-order">{{ entry_sort_order }}</label>]]></search>
            <add position="after"><![CDATA[
            <div class="form-group">
              <label class="col-sm-2 control-label">{{ text_blog_category }}</label>
              <div class="col-sm-10">
                <div class="well well-sm" style="height: 150px; overflow: auto;">
                  {% for blog_category in blog_categories %}
                  <div class="checkbox">
                    <label>
                      {% if blog_category.blog_category_id in information_to_blog_category %}
                      <input type="checkbox" name="information_to_blog_category[]" value="{{ blog_category.blog_category_id }}" checked="checked" />
                      {{ blog_category.name }}
                      {% else %}
                      <input type="checkbox" name="information_to_blog_category[]" value="{{ blog_category.blog_category_id }}" />
                      {{ blog_category.name }}
                      {% endif %}
                    </label>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            ]]></add>
        </operation>
    </file>

    <!-- Frontend modifications for information (get articles by blog_category) -->
    <file path="catalog/model/catalog/information.php">
        <operation>
            <search><![CDATA[public function getInformation($information_id) {]]></search>
            <add position="before"><![CDATA[
            public function getInformations($data = array()) {
                $sql = "SELECT i.*, id.title, id.description FROM `information` i LEFT JOIN `information_description` id ON (i.information_id = id.information_id) LEFT JOIN `blog_to_category` b2c ON (i.information_id = b2c.information_id) WHERE id.language_id = '" . (int)$this->config->get('config_language_id') . "' AND i.status = '1'";
                if (!empty($data['filter_blog_category_id'])) {
                    $sql .= " AND b2c.blog_category_id = '" . (int)$data['filter_blog_category_id'] . "'";
                }
                $sql .= " ORDER BY i.date_added " . $data['order'];
                if (isset($data['start']) || isset($data['limit'])) {
                    if ($data['start'] < 0) $data['start'] = 0;
                    if ($data['limit'] < 1) $data['limit'] = 20;
                    $sql .= " LIMIT " . (int)$data['start'] . "," . (int)$data['limit'];
                }
                $query = $this->db->query($sql);
                return $query->rows;
            }

            public function getTotalInformations($data = array()) {
                $sql = "SELECT COUNT(DISTINCT i.information_id) AS total FROM `information` i LEFT JOIN `blog_to_category` b2c ON (i.information_id = b2c.information_id) WHERE i.status = '1'";
                if (!empty($data['filter_blog_category_id'])) {
                    $sql .= " AND b2c.blog_category_id = '" . (int)$data['filter_blog_category_id'] . "'";
                }
                $query = $this->db->query($sql);
                return $query->row['total'];
            }
            ]]></add>
        </operation>
    </file>

    <file path="admin/language/ru-ru/catalog/information.php">
        <operation>
            <search><![CDATA[$_['heading_title']          = 'Информационные страницы';]]></search>
            <add position="after"><![CDATA[
            $_['text_blog_category'] = 'Категории блога';
            ]]></add>
        </operation>
    </file>
</modification>