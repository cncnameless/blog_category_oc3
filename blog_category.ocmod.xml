<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>Blog Category System</name>
    <code>blog_category</code>
    <version>1.0</version>
    <author>cncnameless</author>
    <link>https://github.com/cncnameless</link>

    <!-- ==================== ADMIN MENU MODIFICATIONS ==================== -->
    <file path="admin/controller/common/column_left.php">
        <operation>
            <search><![CDATA[
            // Catalog
            ]]></search>
            <add position="before"><![CDATA[
            // Blog
            $blog = array();

            if ($this->user->hasPermission('access', 'extension/module/blog_category')) {
                $blog[] = array(
                    'name'     => 'Blog Categories',
                    'href'     => $this->url->link('extension/module/blog_category', 'user_token=' . $this->session->data['user_token'], true),
                    'children' => array()
                );
            }

            if ($blog) {
                $catalog[] = array(
                    'name'     => 'Blog',
                    'href'     => '',
                    'children' => $blog,
                    'icon'     => 'fa-book'
                );
            }
            ]]></add>
        </operation>
    </file>

    <!-- ==================== CATALOG CONTROLLER MODIFICATIONS ==================== -->
    <file path="catalog/controller/startup/seo_url.php">
        <operation>
            <search><![CDATA[
            if ($query->row['query'] && $url[0] == 'information_id') {
            ]]></search>
            <add position="before"><![CDATA[
            // Blog Category Routes
            if ($url[0] == 'blog_category_id') {
                $this->request->get['blog_category_id'] = $url[1];
            }
            
            if (isset($this->request->get['blog_category_id'])) {
                $this->request->get['route'] = 'extension/module/blog_category';
            }
            ]]></add>
        </operation>
        
        <operation>
            <search><![CDATA[
            } elseif (isset($this->request->get['information_id'])) {
            ]]></search>
            <add position="before"><![CDATA[
            } elseif (isset($this->request->get['blog_category_id'])) {
                $this->request->get['route'] = 'extension/module/blog_category';
            ]]></add>
        </operation>
    </file>

    <!-- ==================== MODEL MODIFICATIONS ==================== -->
    <file path="admin/model/catalog/category.php">
        <operation>
            <search><![CDATA[
            public function getCategory($category_id) {
            ]]></search>
            <add position="before"><![CDATA[
    // Blog Category Methods
    public function getBlogCategories($parent_id = 0) {
        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "category c LEFT JOIN " . DB_PREFIX . "category_description cd ON (c.category_id = cd.category_id) WHERE c.parent_id = '" . (int)$parent_id . "' AND c.blog_category = '1' AND cd.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY c.sort_order, cd.name");

        return $query->rows;
    }

    public function getTotalBlogCategories() {
        $query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "category WHERE blog_category = '1'");

        return $query->row['total'];
    }
            ]]></add>
        </operation>
    </file>

    <file path="catalog/model/catalog/category.php">
        <operation>
            <search><![CDATA[
            public function getCategory($category_id) {
            ]]></search>
            <add position="before"><![CDATA[
    // Blog Category Methods
    public function getBlogCategories($parent_id = 0) {
        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "category c LEFT JOIN " . DB_PREFIX . "category_description cd ON (c.category_id = cd.category_id) LEFT JOIN " . DB_PREFIX . "category_to_store c2s ON (c.category_id = c2s.category_id) WHERE c.parent_id = '" . (int)$parent_id . "' AND c.blog_category = '1' AND cd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND c2s.store_id = '" . (int)$this->config->get('config_store_id') . "'  AND c.status = '1' ORDER BY c.sort_order, cd.name");

        return $query->rows;
    }

    public function getBlogCategory($category_id) {
        $query = $this->db->query("SELECT DISTINCT * FROM " . DB_PREFIX . "category c LEFT JOIN " . DB_PREFIX . "category_description cd ON (c.category_id = cd.category_id) LEFT JOIN " . DB_PREFIX . "category_to_store c2s ON (c.category_id = c2s.category_id) WHERE c.category_id = '" . (int)$category_id . "' AND c.blog_category = '1' AND cd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND c2s.store_id = '" . (int)$this->config->get('config_store_id') . "' AND c.status = '1'");

        return $query->row;
    }

    public function getBlogCategoryLayoutId($category_id) {
        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "category_to_layout WHERE category_id = '" . (int)$category_id . "' AND store_id = '" . (int)$this->config->get('config_store_id') . "'");

        if ($query->num_rows) {
            return $query->row['layout_id'];
        } else {
            return 0;
        }
    }
            ]]></add>
        </operation>
    </file>

    <!-- ==================== DATABASE MODIFICATIONS ==================== -->
    <file path="admin/model/design/layout.php">
        <operation>
            <search><![CDATA[
            public function getLayouts($data = array()) {
            ]]></search>
            <add position="before"><![CDATA[
    // Add blog route to layouts
    public function getLayoutRoutes($layout_id) {
        $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "layout_route WHERE layout_id = '" . (int)$layout_id . "'");

        return $query->rows;
    }
            ]]></add>
        </operation>
    </file>

    <!-- ==================== BLOG MODULE INSTALLATION ==================== -->
    <file path="admin/controller/startup/login.php">
        <operation>
            <search><![CDATA[
            if ($this->user->isLogged()) {
            ]]></search>
            <add position="before"><![CDATA[
            // Auto-install Blog Category Module
            $this->load->model('setting/extension');
            $extensions = $this->model_setting_extension->getInstalled('module');
            
            if (!in_array('blog_category', $extensions)) {
                // Install module in extension list
                $this->model_setting_extension->install('module', 'blog_category');
                
                // Add permissions for admin group
                $this->load->model('user/user_group');
                $user_groups = $this->model_user_user_group->getUserGroups();
                
                foreach ($user_groups as $user_group) {
                    if ($user_group['name'] == 'Administrator') {
                        $this->model_user_user_group->addPermission($user_group['user_group_id'], 'access', 'extension/module/blog_category');
                        $this->model_user_user_group->addPermission($user_group['user_group_id'], 'modify', 'extension/module/blog_category');
                    }
                }
                
                // Add blog category field to category table if not exists
                $query = $this->db->query("SHOW COLUMNS FROM `" . DB_PREFIX . "category` LIKE 'blog_category'");
                if (!$query->num_rows) {
                    $this->db->query("ALTER TABLE `" . DB_PREFIX . "category` ADD `blog_category` tinyint(1) NOT NULL DEFAULT '0'");
                }
            }
            ]]></add>
        </operation>
    </file>

    <!-- ==================== ADMIN CATEGORY FORM MODIFICATIONS ==================== -->
    <file path="admin/controller/catalog/category.php">
        <operation>
            <search><![CDATA[
            protected function getForm() {
            ]]></search>
            <add position="after"><![CDATA[
        $this->document->addScript('view/javascript/blog_category.js');
            ]]></add>
        </operation>
        
        <operation>
            <search><![CDATA[
            if (isset($this->request->post['parent_id'])) {
            ]]></search>
            <add position="before"><![CDATA[
        if (isset($this->request->post['blog_category'])) {
            $data['blog_category'] = $this->request->post['blog_category'];
        } elseif (!empty($category_info)) {
            $data['blog_category'] = $category_info['blog_category'];
        } else {
            $data['blog_category'] = 0;
        }
            ]]></add>
        </operation>
    </file>

    <file path="admin/view/template/catalog/category_form.twig">
        <operation>
            <search><![CDATA[
            <label class="col-sm-2 control-label" for="input-parent">{{ entry_parent }}</label>
            ]]></search>
            <add position="before"><![CDATA[
            <div class="form-group">
              <label class="col-sm-2 control-label">{{ entry_blog_category }}</label>
              <div class="col-sm-10">
                <label class="radio-inline">
                  {% if blog_category %}
                  <input type="radio" name="blog_category" value="1" checked="checked" />
                  {{ text_yes }}
                  {% else %}
                  <input type="radio" name="blog_category" value="1" />
                  {{ text_yes }}
                  {% endif %}
                </label>
                <label class="radio-inline">
                  {% if not blog_category %}
                  <input type="radio" name="blog_category" value="0" checked="checked" />
                  {{ text_no }}
                  {% else %}
                  <input type="radio" name="blog_category" value="0" />
                  {{ text_no }}
                  {% endif %}
                </label>
              </div>
            </div>
            ]]></add>
        </operation>
    </file>

    <!-- ==================== CATALOG ROUTES ==================== -->
    <file path="catalog/controller/common/seo_url.php">
        <operation>
            <search><![CDATA[
            if ($query->row['query'] && $url[0] == 'information_id') {
            ]]></search>
            <add position="before"><![CDATA[
            // Blog Category Routes
            if ($url[0] == 'blog_category_id') {
                $this->request->get['blog_category_id'] = $url[1];
            }
            ]]></add>
        </operation>
    </file>

</modification>